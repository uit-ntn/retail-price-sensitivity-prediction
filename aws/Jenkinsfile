pipeline {
  agent any
  environment {
    AWS_REGION = "ap-southeast-1"
    S3_DATA_BUCKET = "retail-mlops-data-<acct>-<region>"
    SM_EXEC_ROLE_ARN = "arn:aws:iam::<acct>:role/sagemaker-exec-role"
    MODEL_PACKAGE_GROUP_NAME = "retail-mlops-group"
    ENDPOINT_NAME = "retail-mlops-endpoint"
  }
  stages {
    stage('Setup') {
      steps {
        sh 'python -m venv .venv && . .venv/bin/activate && pip install -r core/requirements.txt'
      }
    }
    stage('Test') {
      steps {
        sh '. .venv/bin/activate && pytest core/tests'
      }
    }
    stage('Train') {
      steps {
        sh '. .venv/bin/activate && python aws/scripts/create_training_job.py | tee train.log'
      }
    }
    stage('Register') {
      steps {
        sh '. .venv/bin/activate && MODEL_ARTIFACT=$(grep MODEL_ARTIFACT train.log | cut -d" " -f2) python aws/scripts/register_model.py | tee reg.log'
      }
    }
    stage('Deploy') {
      steps {
        sh '. .venv/bin/activate && MODEL_PACKAGE_ARN=$(grep MODEL_PACKAGE_ARN reg.log | cut -d" " -f2) python aws/scripts/deploy_endpoint.py'
      }
    }
  }
}
